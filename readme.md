# Password Recover
Recover password functionality with e-mail sender usign Django Email Backend

## How to start project.

- Create a folder in your machine
- Create a virtual environment
    - python3 -m venv venv
- Start the virtual environment
    - ```. venv/bin/activate``` (Linux)
    - ``venv/Scripts/Activat``e (Windows)
- Inside your venv folder clone the project
    - ```git clone https://github.com/alexlopesbr/forgot-password.git```
- In your-new-folder/venv/forgot-password
    - ```pip install -r requirements.txt``` to install the project's dependencies
    - ```python manage.py migrate``` to generate your database
    - ```python3 manage.py createsuperuser``` to create the admin
    - ```python3 manage.py runserver``` to start the server

## Using the functionality

We have two POST requests:

        {{localhost}}/core/user/forgot-password/<br>
        Send an e-mail with a link to recover the password.


        {{localhost}}/core/user/change-forgotten-password/
        Allows you to enter the new password.

> **Note:** When you start your server the localhost generaly is http://127.0.0.1:8000/.
---

## root
### setings.py
~~~python
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

BASE_URL = 'sandbox.com'

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_HOST_USER = 'email@email.com'
EMAIL_HOST_PASSWORD = 'your-key'
EMAIL_PORT = 587
EMAIL_USE_TLS = True

~~~
>First step, set some configures in settings.py. 
---

## core
### views.py
~~~python
from core.models import User
from rest_framework.response import Response
from .services import send_forgot_password_email
from .exceptions import ForgotPasswordInvalidParams
from rest_framework.permissions import AllowAny
from rest_framework.decorators import action

@action(detail=False, methods=['post'], url_path='forgot-password', permission_classes=[AllowAny])
def forgot_password(self, request):
    if 'email' not in request.POST:
        raise ForgotPasswordInvalidParams
    send_forgot_password_email(request.POST['email'])
    return Response({'worked': True})

@action(detail=False, methods=['post'], url_path='change-forgotten-password', permission_classes=[AllowAny])
def change_forgotten_password(self, request):
    email = request.POST.get('email', None)
    forgot_password_hash = request.POST['forgot_password_hash']
    new_password = request.POST['new_password']
    User.change_password(email, forgot_password_hash, new_password)
    return Response({'worked': True})

~~~
> Here we create a request called ```forgot-password``` to send an **email** with a link to change the password.<br>
> In this case, we are calling the ```send_forgot_password_email``` function. *(see the function details below)*

> We also create a ```change-forgotten-password``` request to change the password. Here we need to send the **email**, the **hash** and the **new password**.
>
> Obs. the hash is an inplicit parameter that is generated by the ```send_forgot_password_email``` function.


> forgot_password_hash and new_password fields are set in core.models.py

### services.py

~~~python
from core.models import User
from emails.services import send_email_forgot_password
from core.exceptions import UserDoesNotExist
from django.utils import timezone
from datetime import timedelta
import re
import urllib.parse

def send_forgot_password_email(email):
    try:
        user = User.objects.get(email=email)
    except User.DoesNotExist:
        raise UserDoesNotExist
    now = timezone.now()
    user.forgot_password_hash = re.sub(r'\D', '', str(now))
    user.forgot_password_expire = now + timedelta(hours=24)
    user.save()
    link = 'https://forgot-password.com/change-password?email=%s&hash=%s' % (
        urllib.parse.quote(user.email), user.forgot_password_hash)
    send_email_forgot_password(user.email, link)

~~~
> In this function we gererate a **hash** with a simple ```timezone.now()``` that will be atribuate to ```forgot_password_hash```. This will be our validator.<br>
> We also set the ```forgot_password_expire``` field with the same ```timezone.now()``` plus the ```timedelta``` of 24 hours. So we give to user 24 hours to change the password.<br>
> We can bring another informations like the name of the user, but we don't use it in this exemple.

>In the ```send_email_forgot_password``` function we send the **email** with the **link** to change the password.
---

## emails
### services.py

~~~python
from django.core.mail import EmailMessage
from django.conf import settings


def open_and_return(my_file):
    with open(settings.BASE_DIR + '/emails/templates/' + my_file, 'r', encoding="utf-8") as file:
        data = file.read()
    return data


def send_email_forgot_password(email, link):
    template = open_and_return("forgot-password.html").format(link)

    msg = EmailMessage(
        u'Email forgot password received',
        template,
        to=[email, ],
        from_email=settings.EMAIL_HOST_USER
    )

    msg.content_subtype = 'html'
    msg.send()

~~~
> The last step is sending the **email** with the **link** to user to change the password.
>
> ```open_and_return``` function opens the **template** and returns the content.<br>
> This template is in ```emails/templates/forgot-password.html``` and will be used to lets our email message prettier.<br>
> In ```template = open_and_return("forgot-password.html").format(link)``` we replace the ```link``` with the **link** that was setted in the ```send_forgot_password_email``` function.

> More information about sending emails in [Django documentation](https://docs.djangoproject.com/en/3.2/topics/email/)
